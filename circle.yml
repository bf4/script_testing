test:
  override:
    - |
      if bin/test; then
        libexec/github_status create "$CI_PR_NUMBER" -owner "$CI_REPO_OWNER" -repo "$CI_REPO_NAME" -url "$CI_BUILD_URL" -context tests -state success -desc "Tests passed"
      else
        libexec/github_status create "$CI_PR_NUMBER" -owner "$CI_REPO_OWNER" -repo "$CI_REPO_NAME" -url "$CI_BUILD_URL" -context tests -state failure -desc "Test failures"
        false # fail the build
      fi
  post:
    - |
      if bin/lint-shell; then
        libexec/github_status create "$CI_PR_NUMBER" -owner "$CI_REPO_OWNER" -repo "$CI_REPO_NAME" -url "$CI_BUILD_URL" -context lint/shell -state success -desc "Shellcheck satisfactory"
      else
        libexec/github_status create "$CI_PR_NUMBER" -owner "$CI_REPO_OWNER" -repo "$CI_REPO_NAME" -url "$CI_BUILD_URL" -context lint/shell -state failure -desc "Shellcheck failed"
        false # fail the build
      fi

dependencies:
  # Cache ShellCheck for subsequent builds
  cache_directories:
    - "~/.cabal"
  post:
  - bin/setup

machine:
  environment:
    PATH: $HOME/.cabal/bin/:$PATH # adds shellcheck to path
    GITHUB_USER_AGENT: "bf4CiStatus"
    CI_PR_NUMBER: "${CIRCLE_PR_NUMBER:-$CIRCLE_SHA1}"
    CI_REPO_OWNER: "$CIRCLE_PROJECT_USERNAME"
    CI_REPO_NAME: "${CIRCLE_PR_REPONAME:-$CIRCLE_PROJECT_REPONAME}"
    CI_BUILD_URL: "$CI_BUILD_URL"
