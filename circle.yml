test:
  override:
    - |
      if bin/test; then
        libexec/github_status create "$GITHUB_STATUS_PR_NUMBER" -context tests -state success -desc "Tests passed" -url "$GITHUB_STATUS_TARGET_URL"
      else
        libexec/github_status create "$GITHUB_STATUS_PR_NUMBER" -context tests -state failure -desc "Test failures" -url "$GITHUB_STATUS_TARGET_URL"
        false # fail the build
      fi
  post:
    - |
      if bin/lint-shell; then
        libexec/github_status create "$GITHUB_STATUS_PR_NUMBER" -context lint/shell -state success -desc "Shellcheck satisfactory"
      else
        libexec/github_status create "$GITHUB_STATUS_PR_NUMBER" -context lint/shell -state failure -desc "Shellcheck failed"
        false # fail the build
      fi

dependencies:
  # Cache ShellCheck for subsequent builds
  cache_directories:
    - "~/.cabal"
  post:
  - bin/setup

machine:
  environment:
    PATH: $HOME/.cabal/bin/:$PATH # adds shellcheck to path
    GITHUB_STATUS_USER_AGENT: "bf4CiStatus"
    GITHUB_STATUS_PR_NUMBER: "${CIRCLE_PR_NUMBER:-$CIRCLE_SHA1}"
    GITHUB_STATUS_REPO_OWNER: "$CIRCLE_PROJECT_USERNAME"
    GITHUB_STATUS_REPO_NAME: "${CIRCLE_PR_REPONAME:-$CIRCLE_PROJECT_REPONAME}"
    GITHUB_STATUS_TARGET_URL: "$CIRCLE_BUILD_URL"
